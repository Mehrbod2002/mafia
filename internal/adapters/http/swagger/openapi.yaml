openapi: 3.0.3
tags:
  - name: Auth
    description: Authentication and access tokens
  - name: User
    description: Profile and wallet management
  - name: Shop
    description: Player-facing shop operations
  - name: Game
    description: Room lifecycle and game flow
  - name: Admin
    description: Administrative management of rules, roles, and scenarios
info:
  title: Mafia API
  version: 1.0.0
  description: |
    HTTP API for the Mafia game platform.

    - **Static documentation:** available at `/swagger/openapi.yaml`.
    - **Dynamic documentation:** Swagger UI at `/swagger/` resolves the server URL from incoming requests and serves `/swagger/openapi.json`.
servers:
  - url: http://localhost:8080
    description: Local development server
paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Request an OTP for registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '200':
          description: OTP has been issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '409':
          description: Phone already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /auth/verify:
    post:
      tags: [Auth]
      summary: Verify OTP and create an account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VerifyOTPRequest'
      responses:
        '200':
          description: Verified and authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT for subsequent requests
                  user_id:
                    type: integer
                    format: uint32
        '401':
          description: Invalid OTP
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /auth/login:
    post:
      tags: [Auth]
      summary: Request an OTP for an existing account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: OTP has been issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/profile:
    get:
      tags: [User]
      summary: Fetch the authenticated user's profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Profile details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '404':
          description: Profile missing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags: [User]
      summary: Update profile fields
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Updated profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
        '400':
          description: Validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/dashboard:
    get:
      tags: [User]
      summary: View dashboard data
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Aggregated player stats and balances
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '400':
          description: Unable to build dashboard
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/wallet:
    get:
      tags: [User]
      summary: View wallet balances
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Wallet balances
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Wallet'
        '404':
          description: Wallet not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /user/purchase:
    post:
      tags: [User]
      summary: Initiate a subscription or currency purchase
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseRequest'
      responses:
        '200':
          description: Payment URL generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  payment_url:
                    type: string
        '400':
          description: Unable to initiate purchase
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /shop/items:
    get:
      tags: [Shop]
      summary: List available shop items
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Items in the shop
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ShopItem'
        '500':
          description: Unable to list items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /shop/purchase:
    post:
      tags: [Shop]
      summary: Purchase an item using wallet funds
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PurchaseItemRequest'
      responses:
        '200':
          description: Purchased item details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ShopItem'
        '400':
          description: Purchase rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /game/rooms:
    post:
      tags: [Game]
      summary: Create a room
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoomRequest'
      responses:
        '200':
          description: Newly created room
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameRoom'
        '400':
          description: Unable to create room
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    get:
      tags: [Game]
      summary: List open rooms
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Available rooms
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GameRoom'
        '500':
          description: Unable to list rooms
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /game/rooms/{id}/join:
    post:
      tags: [Game]
      summary: Join a room
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Joined the room
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Join rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /game/rooms/{id}/leave:
    post:
      tags: [Game]
      summary: Leave a room
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Left the room
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Leave rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /game/rooms/{id}/start:
    post:
      tags: [Game]
      summary: Start the game in a room
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Game started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Cannot start game
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /game/rooms/{id}/phase:
    post:
      tags: [Game]
      summary: Advance to the next phase
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Updated room state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GameRoom'
        '400':
          description: Cannot advance phase
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /game/rooms/{id}/vote:
    post:
      tags: [Game]
      summary: Submit a vote
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VoteRequest'
      responses:
        '200':
          description: Vote recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Vote rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /game/rooms/{id}/ability:
    post:
      tags: [Game]
      summary: Use a role ability
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AbilityRequest'
      responses:
        '200':
          description: Ability recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Ability rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /admin/roles:
    get:
      tags: [Admin]
      summary: List roles
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Role'
    post:
      tags: [Admin]
      summary: Create a role
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        '201':
          description: Created role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /admin/roles/{id}:
    put:
      tags: [Admin]
      summary: Update a role
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        '200':
          description: Updated role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags: [Admin]
      summary: Delete a role
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Role deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Delete rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /admin/rules:
    get:
      tags: [Admin]
      summary: List rules
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Rule'
    post:
      tags: [Admin]
      summary: Create a rule
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleRequest'
      responses:
        '201':
          description: Created rule
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /admin/rules/{id}:
    put:
      tags: [Admin]
      summary: Update a rule
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RuleRequest'
      responses:
        '200':
          description: Updated rule
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags: [Admin]
      summary: Delete a rule
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Rule deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Delete rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /admin/scenarios:
    get:
      tags: [Admin]
      summary: List scenarios
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Scenarios
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Scenario'
    post:
      tags: [Admin]
      summary: Create a scenario
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScenarioRequest'
      responses:
        '201':
          description: Created scenario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Scenario'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /admin/scenarios/{id}:
    put:
      tags: [Admin]
      summary: Update a scenario
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ScenarioRequest'
      responses:
        '200':
          description: Updated scenario
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Scenario'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags: [Admin]
      summary: Delete a scenario
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Scenario deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Delete rejected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    RegisterRequest:
      type: object
      required: [phone]
      properties:
        phone:
          type: string
    VerifyOTPRequest:
      type: object
      required: [phone, otp]
      properties:
        phone:
          type: string
        otp:
          type: string
        name:
          type: string
        age:
          type: integer
        gender:
          type: string
    LoginRequest:
      type: object
      required: [phone]
      properties:
        phone:
          type: string
    UpdateProfileRequest:
      type: object
      properties:
        name:
          type: string
        avatar:
          type: string
    PurchaseRequest:
      type: object
      required: [plan_id]
      properties:
        plan_id:
          type: string
    CreateRoomRequest:
      type: object
      properties:
        type:
          type: string
    VoteRequest:
      type: object
      required: [target_id]
      properties:
        target_id:
          type: integer
          format: uint32
    AbilityRequest:
      type: object
      required: [ability, target_id]
      properties:
        ability:
          type: string
        target_id:
          type: integer
          format: uint32
    PurchaseItemRequest:
      type: object
      required: [item_id]
      properties:
        item_id:
          type: integer
          format: uint32
    CreateRoleRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
        abilities:
          type: array
          items:
            type: string
        team:
          type: string
        max_count:
          type: integer
    RuleRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
        phase:
          type: string
        enabled:
          type: boolean
    ScenarioRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string
        rules:
          type: array
          items:
            type: string
        roles:
          type: array
          items:
            type: string
    Profile:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        name:
          type: string
        avatar:
          type: string
        gender:
          type: string
        age:
          type: integer
        level:
          type: integer
        wins:
          type: integer
        losses:
          type: integer
        play_time:
          type: integer
        friends:
          type: integer
        medals:
          type: array
          items:
            type: string
    Wallet:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        coins:
          type: integer
        diamonds:
          type: integer
    ShopItem:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        type:
          type: string
        price:
          type: integer
        currency:
          type: string
        stock:
          type: integer
        metadata:
          type: object
          additionalProperties: true
    GameRoom:
      type: object
      properties:
        id:
          type: integer
        code:
          type: string
        type:
          type: string
        host_id:
          type: integer
        status:
          type: string
        phase:
          type: string
        day_count:
          type: integer
        winner:
          type: string
        results:
          type: string
    Role:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        abilities:
          type: array
          items:
            type: string
        team:
          type: string
        max_count:
          type: integer
    Rule:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        phase:
          type: string
        enabled:
          type: boolean
    Scenario:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        description:
          type: string
        rules:
          type: array
          items:
            type: string
        roles:
          type: array
          items:
            type: string
    MessageResponse:
      type: object
      properties:
        message:
          type: string
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
